{%- liquid
  capture unit_price
    render 'unit-price', measurement: product.variants.first.unit_price_measurement
  endcapture

  assign percentages = ''
  if product.has_only_default_variant
    if product.price < product.compare_at_price
      assign percentage = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price | ceil
      assign percentages = percentages | append: percentage | append: ','
    endif
  else
    for variant in product.variants
      if variant.price < variant.compare_at_price
        assign percentage = variant.compare_at_price | minus: variant.price | times: 100 | divided_by: variant.compare_at_price | ceil
        assign percentages = percentages | append: percentage | append: ','
      endif
    endfor
  endif
  assign lowest_percentage = percentages | split: ',' | uniq | sort | first
-%}

<li class="grid gap-2">
  <a class="group grid gap-2" href="{{ product.url | within: collection }}">
    <figure class="relative">
      <div class="bg-white overflow-hidden shadow-lg rounded-xl">
        {%- if product.featured_image -%}
          {{ product.featured_image
            | image_url: width: 500, height: 500
            | image_tag: class: 'w-full group-hover:scale-110 transition-transform duration-300 ease-in-out', loading: 'lazy'
          }}
        {%- else -%}
          {{ 'product-1' | placeholder_svg_tag }}
        {%- endif -%}
      </div>

      {%- if sale_badge_enabled and lowest_percentage -%}
        <span class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">
          Save {{ lowest_percentage }}%
        </span>
      {%- endif -%}
    </figure>

    <div class="text-lg font-semibold group-hover:underline text-gray-800">{{ product.title | default: 'Product title' }}</div>
  </a>

  <div class="text-sm text-gray-600">
    {%- if product.price_varies -%}From{%- endif %}
    <span>
      <strong class="text-xl text-gray-900">{{ product.price_min | default: 0 | money }}</strong>
      {{- unit_price -}}
    </span>
    {% if product.selected_or_first_available_variant.price < product.selected_or_first_available_variant.compare_at_price %}
      <span class="ml-2 text-gray-400 line-through">
        {{ product.selected_or_first_available_variant.compare_at_price | money }}
      </span>
    {% endif %}
  </div>

  {%- unless product.has_only_default_variant -%}
    <nav class="text-xs mt-1">
      <div class="text-gray-500">{{ product.variants.size | default: 'No' }} options</div>
      <div class="flex flex-wrap gap-1">
        {%- for product_option in product.options_with_values -%}
          {%- for value in product_option.values -%}
            {%- for variant in product.variants -%}
              {%- if variant.title contains value -%}
                <a class="text-blue-600 hover:text-blue-800" href="{{ variant.url }}" aria-label="{{ product_option.name }}">
                  {{- value -}}
                </a>
                {% break %}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
        {%- endfor -%}
      </div>
    </nav>
  {%- endunless -%}
</li>