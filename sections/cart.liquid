<header class="text-center rte">
  {%- if section.settings.content != blank -%}
    {{ section.settings.content }}
  {%- else -%}
    <h1>{{ page_title }}</h1>
  {%- endif -%}

  {%- if cart.empty? -%}
    <p>Your cart is empty</p>
  {%- endif -%}

  <p>
    <a class="action" href="{{ section.settings.empty_cta_link }}">
      {{ section.settings.empty_cta_label | default: 'Continue shopping' }}
    </a>
  </p>
</header>

{%- unless cart.empty? -%}
  {% form 'cart', cart, class: 'grid gap-8 max-w-screen-lg mx-auto' %}
    <ul class="mt-8">
      {%- for line_item in cart.items -%}
        <li class="line-item grid grid-cols-[auto,1fr,auto] items-center gap-4 pb-4 border-b border-neutral-200 [&+&]:mt-4">
          <figure class="self-start w-[80px] md:w-[100px]">
            {{ line_item.image
              | image_url: width: 200, height: 200
              | image_tag: loading: 'lazy'
              | link_to: line_item.url
            }}
          </figure>

          <dl class="grid gap-2 justify-start">
            <dt class="flex flex-wrap gap-x-[.5em]">
              <a class="font-bold text-lg hover:underline" href="{{ line_item.url }}">
                {{ line_item.product.title }}
              </a>

              {%- unless line_item.product.has_only_default_variant -%}
                <div class="flex flex-wrap items-center gap-[.25em]">
                  {%- for option in line_item.options_with_values -%}
                    <small class="hashtag text-xs" title="{{ option.name }}">{{ option.value }}</small>
                  {%- endfor -%}
                </div>
              {%- endunless -%}
            </dt>

            <dd class="flex gap-[.5em]">
              <span class="price">{{ line_item.original_price | money }}</span>
              <label title="Quantity">
                {% render 'quantity-selector',
                  name: 'updates[]',
                  value: line_item.quantity,
                  min: 0
                %}
              </label>
            </dd>

            {% comment %} Discounts {% endcomment %}
            {%- if line_item.discounts.size > 0 -%}
              <dd class="mt-2 p-2 pt-1 bg-gradient-to-r from-warning/20 to-transparent">
                <div class="technical text-[10px] -mt-[1em]">Discounts</div>

                {%- for discount in line_item.discounts -%}
                  <dl class="grid grid-cols-[1fr,auto] gap-x-4 items-center">
                    <dt>{{ discount.title }}</dt>
                    <dd class="price-negative text-right">{{ discount.amount | money }}</dd>
                  </dl>
                {%- endfor -%}
              </dd>
            {%- endif -%}
          </dl>

          <a
            class="self-stretch with-icon ghost text-sm"
            href="{{ line_item.url_to_remove }}"
            title="Remove {{ line_item.title }} from cart"
          >
            {%- render 'icon' with 'delete' -%}
          </a>
        </li>
      {%- endfor -%}
    </ul>

    <div class="grid sm:flex flex-wrap items-start gap-8 sm:ml-auto">
      {% comment %} Cart note {% endcomment %}
      <label class="flex flex-col items-start gap-1">
        <span class="relative z-[1] technical px-[.5em] ml-1 text-[10px] bg-white -mb-[1.2em]">Cart note</span>
        <textarea
          class="input p-2 w-full min-h-[2.5em] max-h-[12em] leading-tight"
          name="note"
          cols="30" rows="3"
          placeholder="Cart notes"
        >{{ cart.note }}</textarea>
      </label>

      {% comment %} Cart summary {% endcomment %}
      <div class="grid gap-4">
        <dl class="grid grid-cols-[1fr,auto] gap-x-4 [&_dd]:text-right">
          {%- if cart.total_discount > 0 -%}
            <dt>Original total price</dt>
            <dd class="price">{{ cart.original_total_price | money }}</dd>

            <dt>Total discounts</dt>
            <dd class="price-negative">{{ cart.total_discount | money }}</dd>

            {%- if cart.cart_level_discount_applications.size > 0 -%}
              <details class="col-span-full pl-2 text-sm" open>
                <summary class="technical text-[10px]">Includes</summary>

                <div class="grid grid-cols-[1fr,auto] gap-x-4 [&_dd]:text-right">
                  {%- for discount in cart.cart_level_discount_applications -%}
                    <dt>
                      {{ discount.title }}

                      {%- if discount.value_type == 'percentage' -%}
                        <small>({{ discount.value | append: '% off' }})</small>
                      {%- endif -%}
                    </dt>
                    <dd class="price-negative">
                      {{ discount.total_allocated_amount | money }}
                    </dd>
                  {%- endfor -%}

                  {%- for line_item in cart.items -%}
                    {%- for discount in line_item.discounts -%}
                      <dt>{{ discount.title }}</dt>
                      <dd class="price-negative">{{ discount.amount | money }}</dd>
                    {%- endfor -%}
                  {%- endfor -%}
                </div>
              </details>
            {%- endif -%}

            <hr class="col-span-full my-2">
          {%- endif -%}

          <dt><b>Subtotal</b></dt>
          <dd class="price"><b>{{ cart.total_price | money }}</b></dd>
        </dl>

        <div class="grid gap-2">
          <input class="action-secondary animate-pulse disabled:hidden" type="submit" value="Update cart" disabled />
          <button class="action" name="checkout" type="submit">
            {{ section.settings.checkout_label | default: 'Checkout' }}
          </button>
        </div>
      </div>
    </div>
  {% endform %}
{%- endunless -%}

<script defer>
  const cartForm = document.querySelector('#cart_form')

  cartForm.querySelectorAll('[name="updates[]"], [name="note"]').forEach(input => {
    input.addEventListener('input', ({ target }) => {
      target.setAttribute('value', Math.max(0, target.valueAsNumber))
      target.classList.add('border-warning', 'bg-warning/10', 'animate-pulse')
      cartForm.querySelector('input[type="submit"]').removeAttribute('disabled')
    })
  })
</script>

{% schema %}
{
  "name": "Cart",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "richtext",
      "id": "content",
      "label": "Content"
    },
    {
      "type": "text",
      "id": "checkout_label",
      "label": "Checkout label",
      "placeholder": "Checkout"
    },
    {
      "type": "header",
      "content": "Empty state"
    },
    {
      "type": "text",
      "id": "empty_cta_label",
      "label": "Empty CTA label",
      "placeholder": "Continue shopping"
    },
    {
      "type": "url",
      "id": "empty_cta_link",
      "label": "Empty CTA link"
    }
  ]
}
{% endschema %}
